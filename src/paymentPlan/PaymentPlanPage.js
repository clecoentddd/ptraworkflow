
// PaymentPlanPage.js
// Displays the current payment plan using event-sourced projections
import React, { useState } from 'react';
import '../layout.css';
import ProcessFlowStatusBar from '../sharedProjections/ProcessFlowStatusBar';
import { readWorkflowEventLog } from '../workflowEventLog';
import { getPaymentPlanState } from './paymentPlanProjection';
import EventStream from '../components/EventStream';
import { getPaymentTransactions } from './paymentTransactionProjection';
import { createPaiementDemandeEvent, createPaiementEffectueEvent } from './paymentTransactionSlice';
import { appendWorkflowEvents } from '../workflowEventLog';

export default function PaymentPlanPage() {
  const eventLog = readWorkflowEventLog();
  const paymentPlanProjection = getPaymentPlanState(eventLog);
  // Use planDeCalculId as fallback if paymentPlanId is null
  const paymentPlan = paymentPlanProjection ? {
    ...paymentPlanProjection,
    paymentPlanId: paymentPlanProjection.paymentPlanId || paymentPlanProjection.planDeCalculId
  } : null;
  // Transaction state is now event-sourced
  const [showProjection, setShowProjection] = useState(false);

  // Helper: get last day of month
  function getLastDayOfMonth(monthStr) {
    const [yyyy, mm] = monthStr.split('-').map(Number);
    return new Date(yyyy, mm, 0); // day 0 of next month = last day of month
  }

  // Handler for payment
  function handlePay(month, amount) {
    // Find existing transaction for this month
    const transactions = getPaymentTransactions(eventLog);
    let tx = transactions.find(t => t.month === month && t.paymentPlanId === paymentPlan.paymentPlanId);
    if (!tx) {
      // If no transaction, create PaiementDemandé event first
      const dueDate = getLastDayOfMonth(month).toISOString();
      const demandeEvent = createPaiementDemandeEvent({
        transactionId: `${paymentPlan.paymentPlanId}-${month}`,
        paymentPlanId: paymentPlan.paymentPlanId,
        month,
        dueDate,
        amount
      });
      appendWorkflowEvents(demandeEvent);
      tx = { ...demandeEvent, status: 'Demandé', history: [demandeEvent] };
    }
    // Append PaiementEffectué event
    const effectueEvent = createPaiementEffectueEvent({
      transactionId: tx.transactionId,
      paymentPlanId: paymentPlan.paymentPlanId,
      month,
      amount
    });
    appendWorkflowEvents(effectueEvent);
  }

  const today = new Date();
  const transactions = getPaymentTransactions(eventLog).filter(t => t.paymentPlanId === paymentPlan.paymentPlanId);




  // EventStream filter: PaymentPlanAutoGenerated and PaiementEffectué events for this plan
  const eventStreamFilter = e => (
    (e.event === 'PaymentPlanAutoGenerated' &&
      (e.changeId === paymentPlan.changeId || e.planDeCalculId === paymentPlan.planDeCalculId)) ||
    (e.event === 'PaiementEffectué' && e.paymentPlanId === paymentPlan.paymentPlanId)
  );

  if (!paymentPlan) {
    return (
      <div>No payment plan available.</div>
    );
  }

  return (
    <>
      <div className="workflow-main-container">
        <ProcessFlowStatusBar />
        <div className="event-stream-section" style={{ position: 'relative' }}>
          <h2>Payment Plan</h2>
          <div style={{ marginBottom: 18 }}>
            <strong>Change ID:</strong> {paymentPlan.changeId}<br />
            <strong>Plan de Calcul ID:</strong> {paymentPlan.planDeCalculId}<br />
            <strong>Payment Plan ID:</strong> {paymentPlan.paymentPlanId}<br />
            <strong>Type:</strong> {paymentPlan.isAutoGenerated ? 'Auto-generated (created by automation)' : 'Manual (created by user)'}
          </div>
          <button
            className="projection-btn"
            onClick={() => setShowProjection(s => !s)}
          >
            {showProjection ? 'Masquer Projection' : 'Afficher Projection'}
          </button>
          {showProjection && (
            <div className="projection-popup">
              <button className="projection-close-btn" onClick={() => setShowProjection(false)}>
                Fermer
              </button>
              <pre style={{ background: '#222', color: '#fff', padding: 16, borderRadius: 8, fontSize: 13, marginBottom: 18 }}>
                {JSON.stringify(paymentPlanProjection, null, 2)}
              </pre>
            </div>
          )}

          <table className="workflow-table" style={{ marginTop: '1rem' }}>
            <thead>
              <tr>
                <th>Month</th>
                <th>Amount</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {paymentPlan.payments.map(({ month, amount }) => {
                const lastDay = getLastDayOfMonth(month);
                const tx = transactions.find(t => t.month === month);
                const canPay = today >= lastDay && (!tx || tx.status !== 'Effectué');
                return (
                  <tr key={month}>
                    <td>{month}</td>
                    <td>{amount}</td>
                    <td>
                      {canPay ? (
                        <button onClick={() => handlePay(month, amount)} className="plan-de-calcul-calc-btn">Payer</button>
                      ) : tx && tx.status === 'Effectué' ? (
                        <span className="plan-de-calcul-paid">Payé</span>
                      ) : (
                        <span className="plan-de-calcul-pending">En attente</span>
                      )}
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
        {/* EventStream outside the main container */}
        <EventStream
          events={eventLog}
          filter={eventStreamFilter}
          maxHeight={400}
          showTitle={true}
        />
      </div>
    </>
  );
}
