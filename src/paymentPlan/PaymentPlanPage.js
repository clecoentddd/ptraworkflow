// PaymentPlanPage.js
// Displays the current payment plan using event-sourced projections
import React, { useState } from 'react';
import { useAuthUser } from '../auth/AuthUserContext';
import '../layout.css';
import './PaymentPlanPage.css';
import ProcessFlowStatusBar from '../sharedProjections/ProcessFlowStatusBar';
import { readWorkflowEventLog, appendWorkflowEvents } from '../workflowEventLog';
import { getPaymentPlanState } from './paymentPlanProjection';
import EventStream from '../components/EventStream';
import { getPaymentTransactions } from '../paymentTransaction/paymentTransactionProjection';
import { createPaiementDemandeEvent } from '../paymentTransaction/paymentTransactionSlice';
import { handlePay } from '../paymentTransaction/handlePay';

export default function PaymentPlanPage() {
  const { user, isAuthenticated, isLoading } = useAuthUser();
  const [refresh, setRefresh] = useState(0);
  const [popup, setPopup] = useState(null);
  const [showProjection, setShowProjection] = useState(false);

  const eventLog = readWorkflowEventLog();

  if (!isAuthenticated && !isLoading) {
    return (
      <div style={{ color: 'red', padding: '2rem', fontWeight: 'bold', background: '#fff0f0' }}>
        You must be authenticated to view the payment plan.
      </div>
    );
  }

  const paymentPlanProjection = getPaymentPlanState(eventLog);

  const paymentPlan = paymentPlanProjection
    ? {
        ...paymentPlanProjection,
        paymentPlanId:
          paymentPlanProjection.paymentPlanId ||
          paymentPlanProjection.planDeCalculId
      }
    : null;

  // Helper: get last day of month
  function getLastDayOfMonth(monthStr) {
    const [yyyy, mm] = monthStr.split('-').map(Number);
    return new Date(yyyy, mm, 0); // last day of month
  }



  if (!paymentPlan) {
    return <div>No payment plan available.</div>;
  }

  const eventStreamFilter = e =>
    e.event === 'PaiementDemandé' || e.event === 'PaiementEffectué' || e.event === 'PaiementRejected';

  return (
    <>
      {popup && (
        <div className="payment-popup" style={{ borderColor: popup.color }}>
          <span className="payment-popup-message" style={{ color: popup.color }}>
            {popup.message}
          </span>
          <button
            className="payment-popup-close-btn"
            style={{ background: popup.color }}
            onClick={() => setPopup(null)}
          >
            Fermer
          </button>
        </div>
      )}

      <div className="workflow-main-container">
        <ProcessFlowStatusBar />

        <div className="event-stream-section" style={{ position: 'relative' }}>
          <h2>Payment Plan</h2>

          <div className="plan-ids-bar">
            <div className="plan-id-row"><span className="plan-id-label">Change ID:</span> <span className="plan-id-value">{paymentPlan.changeId}</span></div>
            <div className="plan-id-row"><span className="plan-id-label">Plan de Calcul ID:</span> <span className="plan-id-value">{paymentPlan.planDeCalculId}</span></div>
            <div className="plan-id-row"><span className="plan-id-label">Payment Plan ID:</span> <span className="plan-id-value">{paymentPlan.paymentPlanId}</span></div>
            <div className="plan-id-row"><span className="plan-id-label">Type:</span> <span className="plan-id-value">{paymentPlan.isAutoGenerated ? 'Auto-generated (created by automation)' : 'Manual (created by user)'}</span></div>
          </div>

          <button
            className="projection-btn"
            onClick={() => setShowProjection(s => !s)}
          >
            {showProjection ? 'Masquer Projection' : 'Afficher Projection'}
          </button>

          {showProjection && (
            <div className="projection-popup">
              <button
                className="projection-close-btn"
                onClick={() => setShowProjection(false)}
              >
                Fermer
              </button>
              <pre className="projection-pre">
                {JSON.stringify(paymentPlanProjection, null, 2)}
              </pre>
            </div>
          )}

          <table className="workflow-table" style={{ marginTop: '1rem' }}>
            <thead>
              <tr>
                <th>Month</th>
                <th>Amount</th>
                <th style={{ width: '180px' }}>Transaction ID</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {paymentPlan.payments.map(({ month, amount, transactionId }) => {
                const transactionsForMonth = getPaymentTransactions(eventLog).filter(
                  t =>
                    t.month === month &&
                    t.paymentPlanId === paymentPlan.paymentPlanId
                );
                const paidTx = transactionsForMonth.find(t => t.status === 'Effectué' || t.status === 'Remboursé');
                const alreadySettled = !!paidTx;
                return (
                  <tr key={month}>
                    <td>{month}</td>
                    <td>{Number(amount).toFixed(2)}</td>
                    <td style={{ fontFamily: 'monospace', fontSize: '1em', maxWidth: 180, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{transactionId?.slice(0, 8)}…</td>
                    <td>
                      {alreadySettled ? (
                        <span style={{ color: 'green', fontWeight: 'bold' }}>
                          Transaction Effectué<br />
                          <span style={{ fontWeight: 'normal', fontSize: '0.95em' }}>
                            le {paidTx.timestamp?.slice(0, 10)} à {paidTx.timestamp?.slice(11, 19)}
                          </span>
                        </span>
                      ) : (
                        <button
                          className="plan-de-calcul-calc-btn"
                          onClick={() => handlePay({ user, paymentPlan, eventLog, appendWorkflowEvents, setPopup, setRefresh }, month, amount)}
                        >
                          Pay
                        </button>
                      )}
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>

          <EventStream
            events={eventLog}
            filter={eventStreamFilter}
            maxHeight={400}
            showTitle={true}
          />
        </div>
      </div>
    </>
  );
}
